!function(m,C,B){"use strict";var T="ht",p=m[T],n=p.Default,Q=n.def,F=n.getInternal();p.HistoryManager=function(i){this._histories=[],this.setDataModel(i)},Q(p.HistoryManager,C,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var n=this;n._betweenTransaction++,1===n._betweenTransaction&&(n._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var O=this,e=O._histories;O._betweenTransaction>0&&O._betweenTransaction--,0===O._betweenTransaction&&(O._transactionHistories&&O._transactionHistories.length&&(e=e.slice(0,O._historyIndex+1),e.push(O._transactionHistories),e.length>O._maxHistoryCount&&(e=e.slice(e.length-O._maxHistoryCount)),O.setHistories(e),O.setHistoryIndex(e.length-1,!0)),delete O._transactionHistories)}},setDataModel:function(Q){var b=this,T=b._dataModel;T!==Q&&(T&&(delete T._historyManager,T.ump(b.handleDataModelPropertyChange,b),T.umm(b.$5p,b),T.umd(b.$6p,b),T.removeHierarchyChangeListener(b.handleHierarchyChange,b),T.removeIndexChangeListener(b.handleIndexChange,b)),b._dataModel=Q,Q&&(Q._historyManager=b,Q.mp(b.handleDataModelPropertyChange,b),Q.mm(b.$5p,b),Q.md(b.$6p,b),Q.addHierarchyChangeListener(b.handleHierarchyChange,b),Q.addIndexChangeListener(b.handleIndexChange,b)),b.fp("dataModel",T,Q),b.clear())},setHistoryIndex:function(L,v){var S=this,X=S._historyIndex,T=S._histories.length;if(-1>L?L=-1:L>=T&&(L=T-1),X!==L){if(!v){var k=L-X;k>0?S.$2p(k):0>k&&S.$1p(-k)}S._historyIndex=L,S.fp("historyIndex",X,L),S.dataModel&&S.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(E){var l=this,q=l._histories,r=l._maxHistoryCount;(!E||0>=E)&&(E=10),r!==E&&(l._maxHistoryCount=E,l.fp("maxHistoryCount",r,E),q.length>E&&l.clear())},cloneValue:function(d){return p.Default.clone(d)},isPropertyUndoable:function(j){return j&&!this.ignoredPropertyMap[j]},isDataModelPropertyUndoable:function(E){return E&&!this.ignoreDataModelPropertyMap[E]},$5p:function(G){this.handleChange(G,G.kind)},$6p:function(S){this.handleChange(S,"property")},handleHierarchyChange:function(b){this.handleChange(b,"hierarchy")},handleIndexChange:function(x){this.handleChange(x,"index")},handleDataModelPropertyChange:function(D){this.handleChange(D,"dataModelProperty")},toChildrenInfo:function(b){var Q={};return Q.data=b,Q.children=[],b.eachChild(function(o){Q.children.push(this.toChildrenInfo(o))},this),Q},restoreChildren:function(A){var N=A.data;A.children.forEach(function(o){var f=o.data;f.getParent()!==N&&N.addChild(f),this._dataModel.contains(f)||this._dataModel.add(f),this.restoreChildren(o)},this)},handleChange:function(u,l){var z=this;if(!(z._disabled||z._isUndoRedoing||n.loadingRefGraph)){var W,e=(z._histories,u.data),E=u.property;if(!e||!(e._refGraph||e instanceof p.RefGraph)){if("property"===l)z.isPropertyUndoable(E,e)&&(W={kind:l,data:e,property:E,oldValue:z.cloneValue(u.oldValue,e,E),newValue:z.cloneValue(u.newValue,e,E),event:u});else if("hierarchy"===l||"index"===l)W={kind:l,data:e,oldIndex:u.oldIndex,newIndex:u.newIndex,event:u};else if("clear"===l)W={kind:l,json:u.json,event:u};else if("add"===l){if(W={kind:l,data:e,event:u,childrenInfo:this.toChildrenInfo(e),parent:e.getParent()},W.parent){var o=z._dataModel.getSiblings(e);W.siblingsIndex=o.indexOf(e)}e instanceof p.Node&&(W.host=e.getHost(),W.attaches=e.getAttaches()?e.getAttaches().toArray():B),e instanceof p.Edge&&(W.source=e.getSource(),W.target=e.getTarget())}else"remove"===l?W={kind:l,data:e,event:u}:"dataModelProperty"===l&&z.isDataModelPropertyUndoable(E,e)&&(W={kind:l,property:E,oldValue:z.cloneValue(u.oldValue,e,E),newValue:z.cloneValue(u.newValue,e,E),event:u});z.addHistory(W)}}},addHistory:function(z){var A=this;if(z)if(A._betweenTransaction){var x=!1;if("property"===z.kind||"dataModelProperty"===z.kind)for(var K=A._transactionHistories.length-1;K>=0;K--){var t=A._transactionHistories[K];if(z.kind===t.kind&&z.property===t.property&&z.data===t.data){z.oldValue=t.oldValue,A._transactionHistories[K]=z,x=!0;break}}x||A._transactionHistories.push(z)}else{var D=A._histories;D=D.slice(0,A._historyIndex+1),D.push([z]),D.length>A._maxHistoryCount&&(D=D.slice(D.length-A._maxHistoryCount)),A.setHistories(D),A.setHistoryIndex(D.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(x){(!x||0>=x)&&(x=1),this.setHistoryIndex(this._historyIndex-x)},$1p:function(U){if(this.canUndo()){var S,v=this,H=v._dataModel,K=v._histories,j=v._historyIndex,l=0;for(v._isUndoRedoing=!0,n.setIsolating(!0);U>0;){if(j>=0&&j<K.length){l++,S=K[j],j--;for(var V=S.length-1;V>=0;V--){var a=S[V],J=a.kind,$=a.data,w=a.property,z=a.event,o=this.cloneValue(a.oldValue,$,w);if(a.undo)a.undo();else if("add"===J)H.remove($,{keepChildren:!0});else if("remove"===J)H.contains($)||H.add($,z.rootsIndex,z.datasIndex);else if("clear"===J)H.deserialize(n.clone(a.json));else if("property"===J)if("parent"===w)o?o.addChild($,z.oldIndex):($.setParent(o),z.oldIndex>=0&&H.moveTo($,z.oldIndex));else{var Y=null;0===w.indexOf("a:")?(Y="attr",w=w.replace("a:","")):0===w.indexOf("s:")?(Y="style",w=w.replace("s:","")):0===w.indexOf("f:")&&(Y="field",w=w.replace("f:","")),F.setPropertyValue($,Y,w,o)}else if("dataModelProperty"===J){var Y=null;0===w.indexOf("a:")?(Y="attr",w=w.replace("a:","")):0===w.indexOf("s:")?(Y="style",w=w.replace("s:","")):0===w.indexOf("f:")&&(Y="field",w=w.replace("f:","")),F.setPropertyValue(H,Y,w,o)}else"hierarchy"===J?H.moveTo($,a.oldIndex):"index"===J&&H.moveToIndex($,a.oldIndex)}}U--}n.setIsolating(!1),delete v._isUndoRedoing,v.afterUndo(l)}},afterUndo:function(){},redo:function(f){(!f||0>=f)&&(f=1),this.setHistoryIndex(this._historyIndex+f)},$2p:function(L){if(this.canRedo()){var G,B=this,c=B._dataModel,Q=B._histories,Z=B._historyIndex,w=0;for(B._isUndoRedoing=!0,n.setIsolating(!0);L>0;){if(Z>=-1&&Z<Q.length-1){w++,Z++,G=Q[Z];for(var q=0;q<G.length;q++){var j=G[q],z=j.kind,N=j.data,K=j.property,S=j.event,R=this.cloneValue(j.newValue,N,K);if(j.redo)j.redo();else if("add"===z)j.parent&&!N.getParent()&&j.parent.addChild(N,j.siblingsIndex),c.contains(N)||c.add(N,S.rootsIndex,S.datasIndex),this.restoreChildren(j.childrenInfo),N instanceof p.Node&&(N.setHost(j.host),j.attaches&&j.attaches.forEach(function(Y){Y.setHost(N)})),N instanceof p.Edge&&(N.setSource(j.source),N.setTarget(j.target));else if("remove"===z)c.remove(N);else if("clear"===z)c.clear();else if("property"===z)if("parent"===K)R?R.addChild(N,S.newIndex):(N.setParent(R),S.newIndex>=0&&c.moveTo(N,S.newIndex));else{var U=null;0===K.indexOf("a:")?(U="attr",K=K.replace("a:","")):0===K.indexOf("s:")?(U="style",K=K.replace("s:","")):0===K.indexOf("f:")&&(U="field",K=K.replace("f:","")),F.setPropertyValue(N,U,K,R)}else if("dataModelProperty"===z){var U=null;0===K.indexOf("a:")?(U="attr",K=K.replace("a:","")):0===K.indexOf("s:")?(U="style",K=K.replace("s:","")):0===K.indexOf("f:")&&(U="field",K=K.replace("f:","")),F.setPropertyValue(c,U,K,R)}else"hierarchy"===z?c.moveTo(N,j.newIndex):"index"===z&&c.moveToIndex(N,j.newIndex)}}L--}n.setIsolating(!1),delete B._isUndoRedoing,this.afterRedo(w)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);